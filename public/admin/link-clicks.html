<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://sh4nerewards.com;
    ">
    <title>Link Clicks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-top: #07121a;
            --bg-bottom: #001017;
            --card-bg: #031016;
            --accent-cyan: #00E0FF;
            --accent-cyan-2: #72F4FF;
            --muted-white: #c7dfe6;
            --thumbnail-yellow: #ffd700;
            --thumbnail-green: #00ff66;
            --text-white: #ffffff;
            --neon-green: #00ff99;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--card-bg);
            color: var(--muted-white);
            min-height: 100vh;
            font-size: clamp(12px, 3vw, 14px);
            overflow-x: hidden;
        }

        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .chart-card:hover {
            background: rgba(0, 224, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 224, 255, 0.2);
        }

        canvas {
            max-height: 200px;
            min-height: 150px;
            width: 100%;
        }

        .placeholder-notice {
            color: var(--muted-white);
            font-size: 0.75rem;
            text-align: center;
            margin-top: 8px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <div class="bg-[var(--card-bg)] p-6 rounded-lg border border-[var(--accent-cyan)]">
            <h2 class="text-lg font-medium text-[var(--text-white)] mb-4">sh4ne bc link click Insights</h2>
            <div id="placeholder-notice" class="placeholder-notice hidden">Using placeholder data due to API error or no data</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="chart-card">
                    <h3 class="text-sm font-medium text-[var(--muted-white)] mb-2">Daily Clicks (Oct 16, 2025)</h3>
                    <canvas id="daily-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="text-sm font-medium text-[var(--muted-white)] mb-2">Weekly Clicks (Oct 10-16, 2025)</h3>
                    <canvas id="weekly-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="text-sm font-medium text-[var(--muted-white)] mb-2">Monthly Clicks (Oct 2025)</h3>
                    <canvas id="monthly-chart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="text-sm font-medium text-[var(--muted-white)] mb-2">Click Analysis</h3>
                    <canvas id="engagement-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Target URL
            const TARGET_URL = 'https://bcgame.st/?i=sh4ner&utm_source=sh4ner';

            // Helper to format dates for WAT (UTC+1)
            const toWATDate = (date) => {
                const offset = 1 * 60 * 60 * 1000; // WAT is UTC+1
                return new Date(new Date(date).getTime() + offset);
            };

            // Placeholder data
            const placeholderData = {
                daily: {
                    labels: ["00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00", "08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00"],
                    data: [5, 10, 3, 7, 12, 8, 15, 20, 10, 5, 8, 12, 15, 10, 7]
                },
                weekly: {
                    labels: ["Oct 10", "Oct 11", "Oct 12", "Oct 13", "Oct 14", "Oct 15", "Oct 16"],
                    data: [50, 70, 60, 80, 90, 85, 75]
                },
                monthly: {
                    labels: Array.from({ length: 31 }, (_, i) => (i + 1).toString()),
                    data: [30, 40, 50, 45, 55, 60, 65, 70, 75, 80, 85, 90, 95, 100, 90, 80, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                },
                engagement: {
                    labels: ["Target URL", "Other URLs"],
                    data: [100, 200]
                }
            };

            // Function to fetch and process link click data
            async function fetchLinkClickData() {
                let isPlaceholder = false;
                try {
                    const response = await fetch('https://sh4nerewards.com/api/tracking/link-clicks?cacheBust=' + Date.now());
                    if (!response.ok) throw new Error(`API failed: ${response.status}`);
                    const linkClicks = await response.json();
                    if (!Array.isArray(linkClicks)) throw new Error('Invalid link click data');

                    console.log('Fetched link clicks:', linkClicks);

                    // Filter for target URL
                    const targetClicks = linkClicks.filter(click => click.url === TARGET_URL);
                    console.log(`Target URL clicks (${TARGET_URL}):`, targetClicks.length);

                    // Process daily clicks (Oct 16, 2025, up to 14:00)
                    const dailyStart = new Date('2025-10-16T00:00:00+01:00');
                    const dailyEnd = new Date('2025-10-16T14:59:59+01:00');
                    const dailyCounts = Array(15).fill(0);
                    const dailyLabels = ["00:00", "01:00", "02:00", "03:00", "04:00", "05:00", "06:00", "07:00", "08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00"];

                    targetClicks.forEach(click => {
                        const date = toWATDate(click.createdAt);
                        if (date >= dailyStart && date <= dailyEnd) {
                            const hour = date.getHours();
                            if (hour < 15) dailyCounts[hour]++;
                        }
                    });

                    // Process weekly clicks (Oct 10-16, 2025)
                    const weeklyStart = new Date('2025-10-10T00:00:00+01:00');
                    const weeklyEnd = new Date('2025-10-16T23:59:59+01:00');
                    const weeklyCounts = Array(7).fill(0);
                    const weeklyLabels = ["Oct 10", "Oct 11", "Oct 12", "Oct 13", "Oct 14", "Oct 15", "Oct 16"];

                    targetClicks.forEach(click => {
                        const date = toWATDate(click.createdAt);
                        if (date >= weeklyStart && date <= weeklyEnd) {
                            const dayDiff = Math.floor((date - weeklyStart) / (24 * 60 * 60 * 1000));
                            if (dayDiff >= 0 && dayDiff < 7) weeklyCounts[dayDiff]++;
                        }
                    });

                    // Process monthly clicks (Oct 1-31, 2025)
                    const monthlyStart = new Date('2025-10-01T00:00:00+01:00');
                    const monthlyEnd = new Date('2025-10-31T23:59:59+01:00');
                    const monthlyCounts = Array(31).fill(0);
                    const monthlyLabels = Array.from({ length: 31 }, (_, i) => (i + 1).toString());

                    targetClicks.forEach(click => {
                        const date = toWATDate(click.createdAt);
                        if (date >= monthlyStart && date <= monthlyEnd) {
                            const day = date.getDate() - 1;
                            monthlyCounts[day]++;
                        }
                    });

                    // Process engagement (target URL vs. others)
                    const targetCount = targetClicks.length;
                    const otherCount = linkClicks.length - targetCount;
                    const engagementLabels = targetCount || otherCount ? ["Target URL", "Other URLs"] : placeholderData.engagement.labels;
                    const engagementData = targetCount || otherCount ? [targetCount, otherCount] : placeholderData.engagement.data;

                    // Log chart data
                    console.log('Daily clicks:', dailyCounts);
                    console.log('Weekly clicks:', weeklyCounts);
                    console.log('Monthly clicks:', monthlyCounts);
                    console.log('Engagement:', { labels: engagementLabels, data: engagementData });

                    return {
                        daily: { labels: dailyLabels, data: dailyCounts },
                        weekly: { labels: weeklyLabels, data: weeklyCounts },
                        monthly: { labels: monthlyLabels, data: monthlyCounts },
                        engagement: { labels: engagementLabels, data: engagementData }
                    };
                } catch (err) {
                    console.error('Error fetching link clicks:', err);
                    console.log('Using placeholder data');
                    isPlaceholder = true;
                    return placeholderData;
                } finally {
                    document.getElementById('placeholder-notice').classList.toggle('hidden', !isPlaceholder);
                }
            }

            // Fetch data
            const clickData = await fetchLinkClickData();

            // Render Daily Clicks Chart
            new Chart(document.getElementById('daily-chart'), {
                type: 'line',
                data: {
                    labels: clickData.daily.labels,
                    datasets: [{
                        label: 'Clicks',
                        data: clickData.daily.data,
                        borderColor: '#00E0FF',
                        backgroundColor: 'rgba(0, 224, 255, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                color: '#c7dfe6',
                                maxTicksLimit: 8
                            }
                        },
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#c7dfe6' }
                        }
                    }
                }
            });

            // Render Weekly Clicks Chart
            new Chart(document.getElementById('weekly-chart'), {
                type: 'line',
                data: {
                    labels: clickData.weekly.labels,
                    datasets: [{
                        label: 'Clicks',
                        data: clickData.weekly.data,
                        borderColor: '#ffd700',
                        backgroundColor: 'rgba(255, 215, 0, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: '#c7dfe6' } },
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#c7dfe6' }
                        }
                    }
                }
            });

            // Render Monthly Clicks Chart
            new Chart(document.getElementById('monthly-chart'), {
                type: 'line',
                data: {
                    labels: clickData.monthly.labels,
                    datasets: [{
                        label: 'Clicks',
                        data: clickData.monthly.data,
                        borderColor: '#00ff99',
                        backgroundColor: 'rgba(0, 255, 153, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        x: { 
                            ticks: { 
                                color: '#c7dfe6',
                                maxTicksLimit: 10
                            }
                        },
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#c7dfe6' }
                        }
                    }
                }
            });

            // Render Click Analysis Chart
            new Chart(document.getElementById('engagement-chart'), {
                type: 'pie',
                data: {
                    labels: clickData.engagement.labels,
                    datasets: [{
                        data: clickData.engagement.data,
                        backgroundColor: ['#00E0FF', '#ffd700'],
                        borderColor: '#031016',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#c7dfe6' }
                        },
                        title: { display: false }
                    }
                }
            });
        });
    </script>
</body>
</html>