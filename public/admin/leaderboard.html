<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com;
        style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com https://fonts.gstatic.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: http://localhost:3000 https://res.cloudinary.com;
        connect-src 'self' http://localhost:3000;
    ">
    <title>Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-top: #07121a;
            --bg-bottom: #001017;
            --card-bg: #031016;
            --accent-cyan: #00E0FF;
            --accent-cyan-2: #72F4FF;
            --muted-white: #c7dfe6;
            --thumbnail-yellow: #ffd700;
            --thumbnail-green: #00ff66;
            --text-white: #ffffff;
            --neon-green: #00ff99;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--card-bg);
            color: var(--muted-white);
            min-height: 100vh;
            font-size: clamp(12px, 3vw, 14px);
            overflow-x: hidden;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0,224,255,0.1);
            border: 1px solid var(--accent-cyan);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(0,224,255,0.2);
        }

        .leaderboard-table th {
            background: rgba(0,224,255,0.2);
            color: var(--text-white);
            font-weight: 600;
        }

        .leaderboard-table tr:last-child td {
            border-bottom: none;
        }

        .leaderboard-table tr:hover {
            background: rgba(0,224,255,0.15);
        }

        .truncate-text {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 640px) {
            .leaderboard-table {
                font-size: 12px;
            }
            .leaderboard-table th,
            .leaderboard-table td {
                padding: 0.5rem;
            }
            .truncate-text {
                max-width: 100px;
            }
        }
    </style>
</head>
<body>
    <main class="w-full px-4 py-6 lg:px-8">
        <div id="leaderboard" class="bg-[var(--card-bg)] p-6 rounded-lg border border-[var(--accent-cyan)]">
            <h2 class="text-lg font-medium text-[var(--text-white)] mb-4">Leaderboard</h2>
            <div id="leaderboard-items" class="overflow-x-auto" data-aos="fade-up">
                <table class="leaderboard-table min-w-full">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                            <th>Total Wager ($)</th>
                            <th>Prize ($)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4" class="text-sm text-[var(--muted-white)] px-4 py-2 text-center">No leaderboard data available</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Embedded leaderboard data as fallback
        const fallbackLeaderboardData = [
            { rank: 1, username: "Ð–Ð•*****Ð§Ð£", totalWager: 243747.58, reward: 3000, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 2, username: "Ma***ts", totalWager: 205427.81, reward: 2000, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 3, username: "Lb*******yb", totalWager: 97128.16, reward: 1000, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 4, username: "El********cc", totalWager: 94694.31, reward: 500, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 5, username: "St********ac", totalWager: 68815, reward: 250, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 6, username: "Ma*****f5", totalWager: 35404.04, reward: 250, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 7, username: "Ki**_K", totalWager: 13919.21, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 8, username: "Ma*****ay", totalWager: 13235.44, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 9, username: "Re**im", totalWager: 11396.51, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 10, username: "Ng******ri", totalWager: 10468.95, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 11, username: "Ø§Ø¨***Ú©Ù„", totalWager: 9752.73, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 12, username: "Az******ðŸš¬", totalWager: 7833.94, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 13, username: "á˜»á“******ðŸŽ­", totalWager: 6474.33, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 14, username: "Tr******oa", totalWager: 6094.99, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 15, username: "Sa**********te", totalWager: 5830.2, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 16, username: "Bu**********ze", totalWager: 5253.2, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 17, username: "Br***um", totalWager: 4680, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 18, username: "à¤¸à¤¾************ðŸš©", totalWager: 4331.13, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 19, username: "ih*****fe", totalWager: 4240, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" },
            { rank: 20, username: "La*****25", totalWager: 3588.75, reward: 0, img: "/img/bc-game-esports-logo-png_seeklogo-619973.png" }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            AOS.init();

            async function fetchLeaderboard() {
                const tbody = document.querySelector('#leaderboard tbody');
                tbody.innerHTML = '';

                try {
                    const response = await fetch(`/api/leaderboard?cacheBust=${Date.now()}`);
                    if (!response.ok) throw new Error(`Leaderboard API failed: ${response.status}`);
                    const { data: entries } = await response.json();
                    let players = entries.length ? entries : fallbackLeaderboardData;

                    if (!players.length) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-sm text-[var(--muted-white)] px-4 py-2 text-center">No leaderboard data available</td></tr>';
                        return;
                    }

                    // Sort and render table
                    const sortedData = [...players].sort((a, b) => (a.rank || Infinity) - (b.rank || Infinity)).map((player, index) => ({ ...player, rank: player.rank || index + 1 }));
                    sortedData.forEach((player, index) => {
                        const tr = document.createElement('tr');
                        tr.className = index % 2 === 0 ? 'bg-[rgba(3,16,22,0.5)]' : '';
                        tr.innerHTML = `
                            <td class="px-4 py-2 text-sm text-[var(--text-white)]">${player.rank || index + 1}</td>
                            <td class="px-4 py-2 text-sm text-[var(--text-white)] truncate-text flex items-center gap-2">
                                ${player.img ? `<img src="${player.img}" class="w-6 h-6 rounded-full" alt="Avatar" />` : ''}
                                ${player.username || 'Unknown'}
                            </td>
                            <td class="px-4 py-2 text-sm text-[var(--muted-white)]">$${Number(player.totalWager || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            <td class="px-4 py-2 text-sm text-[var(--muted-white)]">${player.reward ? '$' + Number(player.reward).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : ''}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    // Notify parent to update sidebar leaderboard count
                    if (window.parent && window.parent.document.getElementById('leaderboard-count')) {
                        window.parent.document.getElementById('leaderboard-count').textContent = players.length || '0';
                        window.parent.document.getElementById('leaderboard-count').classList.toggle('hidden', !players.length);
                    }
                } catch (err) {
                    console.error('Error fetching leaderboard:', err);
                    tbody.innerHTML = '<tr><td colspan="4" class="text-sm text-[var(--muted-white)] px-4 py-2 text-center">Failed to load leaderboard</td></tr>';

                    // Use fallback data
                    const sortedData = [...fallbackLeaderboardData].sort((a, b) => (a.rank || Infinity) - (b.rank || Infinity)).map((player, index) => ({ ...player, rank: player.rank || index + 1 }));
                    sortedData.forEach((player, index) => {
                        const tr = document.createElement('tr');
                        tr.className = index % 2 === 0 ? 'bg-[rgba(3,16,22,0.5)]' : '';
                        tr.innerHTML = `
                            <td class="px-4 py-2 text-sm text-[var(--text-white)]">${player.rank || index + 1}</td>
                            <td class="px-4 py-2 text-sm text-[var(--text-white)] truncate-text flex items-center gap-2">
                                ${player.img ? `<img src="${player.img}" class="w-6 h-6 rounded-full" alt="Avatar" />` : ''}
                                ${player.username || 'Unknown'}
                            </td>
                            <td class="px-4 py-2 text-sm text-[var(--muted-white)]">$${Number(player.totalWager || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            <td class="px-4 py-2 text-sm text-[var(--muted-white)]">${player.reward ? '$' + Number(player.reward).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : ''}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }

            // Initial load and refresh every 4 minutes
            fetchLeaderboard();
            setInterval(fetchLeaderboard, 240000);
        });
    </script>
</body>
</html>